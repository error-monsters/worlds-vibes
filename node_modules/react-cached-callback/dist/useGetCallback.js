"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var react_1 = require("react");
var common_1 = require("./common");
var getKey_1 = __importDefault(require("./getKey"));
var FUNCTION_NAME = 'callback';
function useGetCallback(createCallback, params, _usedValues) {
    var _a = checkParams(params, _usedValues), initGetKeyParams = _a[0], usedValues = _a[1];
    return useGetCallbackInner(createCallback, getKey_1.default(initGetKeyParams), usedValues);
}
exports.default = useGetCallback;
function useGetCallbackInner(createCallback, getKey, usedValues) {
    var _this = this;
    var callbacksCache = react_1.useRef();
    if (!callbacksCache.current) {
        callbacksCache.current = {};
    }
    var usedValuesRef = react_1.useRef();
    var isNewValues = !common_1.arraysEqual(usedValuesRef.current || [], usedValues || []);
    usedValuesRef.current = usedValues;
    react_1.useEffect(function () {
        // update old and clear unused callbacks
        Object.keys(callbacksCache.current[FUNCTION_NAME]).forEach(function (cacheKey) {
            if (callbacksCache.current[FUNCTION_NAME][cacheKey].yetActual) {
                delete callbacksCache.current[FUNCTION_NAME][cacheKey].yetActual;
            }
            else {
                delete callbacksCache.current[FUNCTION_NAME][cacheKey];
            }
        });
    });
    return (function () {
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
        }
        var cache4Function = common_1.getCache(callbacksCache.current, FUNCTION_NAME, getKey.apply(void 0, args));
        if (!cache4Function || isNewValues || !common_1.arraysEqual(cache4Function.args, args)) {
            cache4Function = {};
            cache4Function.func = function () {
                var callArgs = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    callArgs[_i] = arguments[_i];
                }
                return cache4Function.cached.apply(cache4Function, callArgs);
            };
            cache4Function.args = args;
            common_1.setCache(callbacksCache.current, FUNCTION_NAME, getKey.apply(void 0, args), cache4Function);
        }
        cache4Function.cached = createCallback.apply(_this, args);
        cache4Function.yetActual = true;
        return cache4Function.func;
    });
}
exports.useGetCallbackInner = useGetCallbackInner;
function checkParams(params, usedParams) {
    return Array.isArray(params)
        ? [undefined, params]
        : [params, usedParams];
}
exports.checkParams = checkParams;
